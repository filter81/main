<?
error_reporting(0);
file_put_contents ( 'cache_clear_files'."flag" , "0" );
$db=new mysqli ("192.168.0.6:3306","root","1234","xen");
$db->query('SET @@sql_mode = ""');
$debug=1;
set_time_limit (60);
$MaxTimeToCache =86400;
$dir = "./skins/";
$cloak_dir = "./capes/";
if (($_SERVER['REMOTE_ADDR']=='192.168.0.96') and (isset($_GET['sgirl']) or isset($_GET['sboy']) or isset($_GET['sother']))){
	if (isset($_GET['sgirl']))
		$db->query("UPDATE `user_skins` SET `gender` ='girl' WHERE `skin`='".$_GET['sgirl']."'");
	else if (isset($_GET['sboy']))
		$db->query("UPDATE `user_skins` SET `gender` ='boy' WHERE `skin`='".$_GET['sboy']."'");	
	else
		$db->query("UPDATE `user_skins` SET `gender` ='other' WHERE `skin`='".$_GET['sother']."'");	
}
if (isset($_GET['file'])) {
	header("HTTP/1.1 301 Moved Permanently");
	header("Location: https://skins.minecraft-moscow.ru/skins/".$_GET['file']);
	die();
}elseif(isset($_GET['cloak'])){
	header("HTTP/1.1 301 Moved Permanently");
	header("Location: https://skins.minecraft-moscow.ru/capes/".$_GET['cloak']);
	die();
}
require_once "./lang/ru.php";
require "./lang/lang_detect.php";
$lang_detect= new lang_detect;
$params=explode("/", $_SERVER['REQUEST_URI']);
if (isset($params[1]))
	$reqlang=$params[1];
else{
	$lang=$lang_detect->getBestMatch('en', $langs);
	header("HTTP/1.1 301 Moved Permanently"); 
	header("Location: https://skins.minecraft-moscow.ru/$lang/");
	die();
}
$allowed_langs = array ("ru","en","fr","de");
$allowed_locales = array("ru_RU","en_US","fr_FR","de_DE");
parseparams($params);
$langs = array(
		'ru' => array('ru', 'be', 'uk', 'ky', 'ab', 'mo', 'et', 'lv','kz')
);
if ($_COOKIE['lang']!=$reqlang){

	if (in_array($reqlang, $allowed_langs)){
		setcookie("lang", $reqlang,time()+86400,"/");
		$_COOKIE['lang']=$reqlang;
		$lang=$reqlang;
	}	else {
		$lang = $lang_detect->getBestMatch('en', $langs);
		setcookie("lang", $lang,time()+86400,"/");
		header("HTTP/1.1 301 Moved Permanently");
		header("Location: https://skins.minecraft-moscow.ru/$lang/");
		die();
	}
}
if (isset($_COOKIE['lang'])){	
	$lang=$_COOKIE['lang'];
} else {
	$lang = $lang_detect->getBestMatch('en', $langs);
	setcookie("lang", $lang, time()+86400,"/");
}
if (!in_array($lang, $allowed_langs))
	$lang="en";
if ($_SERVER['REQUEST_URI']=="/"){
		header("HTTP/1.1 301 Moved Permanently");	
	header("Location: https://skins.minecraft-moscow.ru/$lang/");
	die();
}

if  (isset($_GET['tags'])){
    if (isset($_GET['add'])){
        if ($_GET['tags']==NULL && $_GET['add']!=NULL){
            $result=$db->query("SELECT * FROM `skin_tags` WHERE `id`=".(int) $_GET['add']);
            $db->query("INSERT INTO `skin_search` SET `tags`='".$result->fetch_row()[1]."'");
            $id=$db->insert_id;
            header("HTTP/1.1 301 Moved Permanently");
            header("Location: https://skins.minecraft-moscow.ru/$lang/tags.$id/add");
            die();
        }elseif ($_GET['tags']!=NULL && $_GET['add']!=NULL) {
            $result=$db->query("SELECT * FROM `skin_tags` WHERE `id`=".(int) $_GET['add']);
            $db->query("UPDATE `skin_search` SET `tags`=CONCAT(`tags`,' ".$result->fetch_row()[1]."') WHERE `id`='". (int) $_GET['tags']."'");
            header("HTTP/1.1 301 Moved Permanently");
            header("Location: https://skins.minecraft-moscow.ru/$lang/tags.".$_GET['tags']."/add");
            die();
        }
    }
}
//file_put_contents ( "langlog.txt" ,$_SERVER['REMOTE_ADDR']." detected path: ". $_SERVER['REQUEST_URI']."\n",FILE_APPEND);
require_once "./lang/".$lang.".php";
if(isset($_GET['width']))
{
	if ($_GET['width']!="HD")
		$_GET['width'] = (int)$_GET['width'];
}
if (($_SERVER['REMOTE_ADDR']=='192.168.0.96') and ($debug==1) and isset($_GET['del'])){
	if (file_exists($dir.$_GET['del'].".png"))
		unlink($dir.$_GET['del'].".png");
	#if (file_exists($cloak_dir.$_GET['del']."png"))
	#	unlink($cloak_dir.$_GET['del']."png");
	$db->query("DELETE FROM `user_skins` WHERE `skin`='".$db->real_escape_string($_GET['del'])."'") or die($db->error);
}
if (isset($_GET['file'])){
	if (file_exists($dir.$_GET['file'])) {
		// c���c����� ����� ������ PHP, ����� �������� ������������ ������ ���������� ��� c�����
		// �c�� ����� �� c������ ���� ����� ������c� � ������ �����c���!
		if (ob_get_level()) {
			ob_end_clean();
		}
		// ��c������� ������� �������� ���� c��������� �����
		header('Content-Description: File Transfer');
		header('Content-Type: image/png');
		header('Content-Disposition: attachment; filename=' . basename($dir.$_GET[file]));
		header('Content-Transfer-Encoding: binary');
		header('Expires: 0');
		header('Cache-Control: must-revalidate');
		header('Pragma: public');
		header('Content-Length: ' . filesize($dir.$_GET[file]));
		// ������ ���� � ���������� ��� ������������
		readfile($dir.$_GET[file]);
		exit;
	}
}

header("http/1.0 200 Ok");
header("Cache-Control: no-cache, no-store");
if (isset($_GET['width'])){ 
	if ($_GET['width'] > 64 || $_GET['width']=="HD") 
		$HD="HD ";
	else
		$HD="";
}
?>
<!DOCTYPE HTML>
<html>
<head>
<base href="https://skins.minecraft-moscow.ru/">
	<style type="text/css">
		.skinpreview {
			width:200px;
			height:300px;
			display:inline-block;
		}
		.btn {
			margin-top: 3px;
		}
		.btn.btn-info.disabled {
			background-color:#cccccc;
			border-color:#bbbbbb;
		}
		.left {
			width: 140px;
			height: 560px;
			display: inline-block;
			vertical-align:top;
			margin: 198px 5px 10px 5px;
		}
	</style>
	<script src="https://skins.minecraft-moscow.ru/js/jquery-1.11.0.min.js" type="text/javascript"></script>
    <!-- Yandex.RTB -->
    <script>window.yaContextCb=window.yaContextCb||[]</script>
    <script src="https://yandex.ru/ads/system/context.js" async></script>
<?php
/* 	<script type="text/javascript">
		// <![CDATA[
		$(document).ready(function(){
		    var allAd = $(".adsbygoogle");
		    var ThisBl = 0;
		    for(s=0; s < allAd.length; s++){
		        if(allAd.eq(s).width() < 10 || allAd.eq(s).height() < 10){
		            if(ThisBl == 0){
		        var bodyh = jQuery(window).height() / 8;
		        var ThisUrl = window.location; ThisBl = 1;
		        $("body").after('<? echo $adblock; ?>');
		        }
		    }
		    }
		});
		// ]]>
	</script>
*/
	if (!isset($_GET['lite'])){?>
	<script src="https://skins.minecraft-moscow.ru/three.js" type="text/javascript"></script>
	<script src="./main.js" type="text/javascript"></script> <?php }?>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<script src="js/bootstrap.min.js" type="text/javascript"></script>
	<title><?php
	
	if (isset($_GET['byname']))
		echo $titlebyname;
	else if (isset($_GET['girls']))
		echo $titleforgirls;
	else if (isset($_GET['boys']))
		echo $titleforboys;
	else
		echo $HD.$title;
	
	
	
	?></title>
	<meta name="viewport" content="width=1050">
	<meta name="description" content="<?echo $HD.$description;?>">
<?php
	if (!isset($_GET['dskin'])){
	   echo "<meta property='og:image' content='https://skins.minecraft-moscow.ru/logoBig.png' />\n";
	   echo "<meta property='og:url' content='https://skins.minecraft-moscow.ru/$lang/' />\n";
	}
	else {
	   echo "<meta property='og:image' content='https://skins.minecraft-moscow.ru/s/skin.php?u=".$_GET['dskin']."' />\n";
	   echo "<meta property='og:url' content='https://skins.minecraft-moscow.ru/$lang/dskin.".$_GET['dskin']."' />\n";
	}
?>
	<meta property="og:title" content="<?echo $HD.$title;?>" />
	<meta property="og:description" content="<?echo $ogdescr;?>" />
	<meta property="og:locale" content="<?echo $locale;?>" />
	<meta property="fb:app_id" content="1463976210340996" />
<?php	
if (($key = array_search($locale, $allowed_locales)) !== false) {
	unset($allowed_locales[$key]);
}

$alt_locales = "";
foreach ($allowed_locales as $alt_locale) 
	echo "	<meta property=\"og:locale:alternate\" content=\"$alt_locale\" />\n";
$files = array();
if((isset($_GET['width']) && in_array($_GET['width'], array(64,128,256,512,1024,'HD'))) || 
	 isset($_GET['capes']) || (!isset($_GET['width'])&&!isset($_GET['capes']))) {
	$files=scandir_by_mtime($dir);
}
$clear_files=array();

//if ($_SERVER['REMOTE_ADDR']=='192.168.0.99') die("1");

$cache_clear_files = json_decode(file_get_contents('s2_cache_clear_files'));
$time_cache_clear_files = json_decode(file_get_contents('s2_cache_clear_files'."time"));
$flag_cache_clear_files = file_get_contents ('cache_clear_files'."flag");

if((!empty($cache_clear_files)  or !empty($time_cache_clear_files)) and ($time_cache_clear_files+($MaxTimeToCache/100)-time() > 0) and !isset($_GET['reload']))
{
    //if ($_SERVER['REMOTE_ADDR']=='192.168.0.99') die("1");
    $clear_files=$cache_clear_files;
} elseif ($flag_cache_clear_files==0 and !isset($_GET['reload'])) {
    //if ($_SERVER['REMOTE_ADDR']=='192.168.0.96') die("1");
	$clear_files=$cache_clear_files;
} else {
	file_put_contents ( 'cache_clear_files'."flag" , "0" );
	foreach ($files as $index => $path){
		if (preg_match('/\.(png)$/',$path)){
			$clear_files[]=$path;
		}
	}
    //if ($_SERVER['REMOTE_ADDR']=='192.168.0.96') {print_r($clear_files);die();}
	file_put_contents('s2_cache_clear_files', json_encode($clear_files));
	file_put_contents('s2_cache_clear_files'."time", json_encode(time()));
	file_put_contents ( 'cache_clear_files'."flag" , "1" );
}


//if ($_SERVER['REMOTE_ADDR']=='192.168.0.96') {print_r(count($clear_files));die("g");}
$pagination_param = "";
if(isset($_GET['width']))
{
	$clear_files = filter_width($dir, $clear_files, $_GET['width']);
	$pagination_param = "/width.".$_GET['width'];
}
else if(isset($_GET['capes']))
{
	$clear_files = getcapes();
	$pagination_param = "/capes";
}
else if(isset($_GET['boys']))
{
	$clear_files = getboys();
	$pagination_param = "/boys";
}
else if(isset($_GET['girls']))
{
	$clear_files = getgirls();
	$pagination_param = "/girls";
}
else if(isset($_GET['other']))
{
	$clear_files = getother();
	$pagination_param = "/other";
}
else if(isset($_GET['unchecked']))
{
	$clear_files = getunchecked();
	$pagination_param = "/unchecked";
}
else if(isset($_GET['tags']) && !isset($_GET['add']))
{
    if ($_GET['tags']!=null){
    	$clear_files = gettags();
    	if ($_GET['tags']!=null)
    	   $pagination_param = "/tags.".$_GET['tags'];
    	else 
    	   $pagination_param = "/tags";    	    
    }
}
else if(isset($_GET['byname']))
{
	if (isset($_POST['search'])){
		$clear_files = getbyname($_POST['search']);
	}
	else
		$clear_files = getbyname();
	$pagination_param = "/byname";
}

$count=count($clear_files);
if ($clear_files!=null){
		$clear_files=array_chunk($clear_files, 8);
}
if (!isset($_GET['p'])) $_GET['p']=0;
if (!isset($_GET['lite'])){
	echo "	<script type='text/javascript'>
				window.onload = function()
		{
				";
		foreach ($clear_files[$_GET['p']] as $index => $path){
			$res=$db->query("SELECT `cloak` FROM `user_skins` WHERE `skin`='".substr($path,0,-4)."' and `cloak`!=''");
			$cpatch=$res->fetch_all();$cpatch=$cpatch[0][0].".png";
		?>
			var P<?php echo $index; ?> = new MSP({
				showcape: true,
				running: false,
				spin: false,
				freezecamera: true,
				container: "#skinpreview<?php echo $index; ?>"
			});
			P<?php echo $index; ?>.changeSkin("<?php echo $dir.$path; ?>");	
			<?php if(file_exists($cloak_dir.$cpatch) && $cpatch!=$path) { ?>
			P<?php echo $index; ?>.changeCape("<?php echo $cloak_dir.$cpatch; ?>");	
		  <?php } ?>
		
	<?php 
	}
	echo "	}
	</script>";
}
#if ($_SERVER['REMOTE_ADDR']=='192.168.0.96' and $debug==1)
#    echo '<script> $( ".ya-share2__icon" ).click(function() {alert( "Handler for .click() called." );});</script>';
?>
	<script async type="text/javascript" src="//yastatic.net/share2/share.js" charset="utf-8"  async="async"></script>
    <style>
    	.ya-share2__title {
    		display: none !important;
    	}
    	.ya-share2 {
       		float: right;
    	    margin-top: -7px;
    	}
    </style>
</head>
<body style="background: url(back.jpg) 50% 0 no-repeat;">
	<?php 
	if ($lang!="ru") echo "
	    <div id='fb-root'></div>
	    <script>(function(d, s, id) {
	        var js, fjs = d.getElementsByTagName(s)[0];
	        if (d.getElementById(id)) return;
	        js = d.createElement(s); js.id = id;
	        js.src = 'https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.10&appId=1463976210340996';
	        fjs.parentNode.insertBefore(js, fjs);
	    }(document, 'script', 'facebook-jssdk'));</script>
	   ";?>
<div class='container' style='text-align:center;margin:0 auto;min-width: 1160px;position:relative; border-radius:5px;'>
<div style="position: absolute; top:5px; left:10px;">
	<ul class="pagination">
	<?php
	if (!isset($_GET['lite'])) {
		echo "<li class=''><a href='"."/".$lang.$pagination_param."/p.". $_GET['p']. "/lite/'>$litev</a></li>";
	} else {
		echo "<li class=''><a href='"."/".$lang.$pagination_param."/p.". $_GET['p']. "/'>$fullv</a></li>";
		$lite="lite/";
	}
?>
	</ul>
</div>
<div style="position: absolute; top:40px; left:10px;">
	<ul class="pagination">
		<?php if ($_GET['p']!="0") {?>
		 <li class="<?php if($lang=='ru') echo 'active'?>"><a href="./ru<?php echo $pagination_param."/p.". $_GET['p']. "/$lite";?>">RU</a></li>
		 <li class="<?php if($lang=='en') echo 'active'?>"><a href="./en<?php echo $pagination_param."/p.". $_GET['p']. "/$lite";?>">EN</a></li>
		 <li class="<?php if($lang=='fr') echo 'active'?>"><a href="./fr<?php echo $pagination_param."/p.". $_GET['p']. "/$lite";?>">FR</a></li>
		 <li class="<?php if($lang=='de') echo 'active'?>"><a href="./de<?php echo $pagination_param."/p.". $_GET['p']. "/$lite";?>">DE</a></li>
		<?php } else {?>
		 <li class="<?php if($lang=='ru') echo 'active'?>"><a href="./ru<?php echo $pagination_param."/$lite";?>">RU</a></li>
		 <li class="<?php if($lang=='en') echo 'active'?>"><a href="./en<?php echo $pagination_param."/$lite";?>">EN</a></li>
		 <li class="<?php if($lang=='fr') echo 'active'?>"><a href="./fr<?php echo $pagination_param."/$lite";?>">FR</a></li>
		 <li class="<?php if($lang=='de') echo 'active'?>"><a href="./de<?php echo $pagination_param."/$lite";?>">DE</a></li>
		<?php }?>
	</ul>
</div>
	<div class="social" style="position:absolute; right:10px; top: 10px;">
		<div class="ya-share2" data-yashareL10n="<?php echo $lang;?>" data-yashareType="big" data-services="vkontakte,facebook,twitter,odnoklassniki,moimir,gplus" data-counter data-lang="<?php echo $lang;?>" data-yashareLink="https://skins.minecraft-moscow.ru/<?php echo $lang;?>/"></div>
	</div>
<img src='logoTransp.png' height='150'  alt="Minecraf skins">
<?php
if(isset($_GET['capes']))
	$inbase = $count." ".literalise($count,"плащ","плаща","плащей");
else
	$inbase = $count." ".literalise($count,"скин","скина","скинов");
if ($lang=="en")
	$inbase = $count." skins";
elseif ($lang=="fr")
	$inbase = $count." skins";
$inbase .=$inresolution;
if(isset($_GET['width']))
	$inbase .= $_GET['width'].'x'.($_GET['width']/2);
else 
	$inbase .= $to.' 1024x512';

echo str_replace( "%inbase%", $inbase, $maintext);?>
    <!-- Yandex.RTB R-A-9028370-1 -->
    <div id="yandex_rtb_R-A-9028370-1"></div>
    <script>
        window.yaContextCb.push(()=>{
            Ya.Context.AdvManager.render({
                "blockId": "R-A-9028370-1",
                "renderTo": "yandex_rtb_R-A-9028370-1"
            })
        })
    </script>
 <div>
	 <ul class='pagination'>
		 <li class="<?php if(!isset($_GET['width'])&&!isset($_GET['capes'])&&!isset($_GET['create'])&&!isset($_GET['byname'])&&!isset($_GET['girls'])&&!isset($_GET['boys'])&&!isset($_GET['tags']))echo 'active'?>"><a href="<? echo "./".$lang."/";?>"><?php echo $allskins;?></a></li>
		 <li class="<?php if($_GET[width]==64)echo 'active'?>"><a href="<? echo "./".$lang."/$lite";?>width.64/">64</a></li>
		 <li class="<?php if($_GET[width]==128)echo 'active'?>"><a href="<? echo "./".$lang."/$lite";?>width.128/">128 HD</a></li>
		 <li class="<?php if($_GET[width]==256)echo 'active'?>"><a href="<? echo "./".$lang."/$lite";?>width.256/">256 HD</a></li>
		 <li class="<?php if($_GET[width]==512)echo 'active'?>"><a href="<? echo "./".$lang."/$lite";?>width.512/">512 HD</a></li>
		 <li class="<?php if($_GET[width]==1024)echo 'active'?>"><a href="<? echo "./".$lang."/$lite";?>width.1024/">1024 HD</a></li>
		 <li class="<?php if($_GET[width]==HD)echo 'active'?>"><a href="<? echo "./".$lang."/$lite";?>width.HD/"><?php echo $hdskins;?></a></li>
		 <li class="<?php if(isset($_GET['capes']))echo 'active'?>"><a href="<? echo "./".$lang."/$lite";?>capes/"><?php echo $skinswithcloaks;?></a></li>
		 <li class="<?php if(isset($_GET['girls']))echo 'active'?>"><a href="<? echo "./".$lang."/$lite";?>girls/"><?php echo $girls;?></a></li>
		 <li class="<?php if(isset($_GET['boys']))echo 'active'?>"><a href="<? echo "./".$lang."/$lite";?>boys/"><?php echo $boys;?></a></li>
		 <li class="<?php if(isset($_GET['tags']))echo 'active'?>"><a href="<? echo "./".$lang."/$lite";?>tags/add"><?php echo $tags;?></a></li>
		 <li class="<?php if(isset($_GET['byname']))echo 'active'?>"><a href="<? echo "./".$lang."/$lite";?>byname/"><?php echo $byname;?></a></li>
	 </ul>
 </div>
<div style='text-align:center;margin:0 auto;position:relative; background-color:white; border-radius:5px;'>
<?php
if ($lang == "ru") 
    echo "<div class='left'><a href='http://www.minecraft-moscow.ru/Begin/?utm_source=skins'><img src='./a/6.gif' style='vertical-align:baseline'></a></div>";
else 
    echo '';
echo "<div class='main' style=' width: 980px; display: inline-block;'>";

if ($lang == "ru") 
    echo '';
if (isset($_GET['byname'])) {
?>
<form name="search" method="post" action="<? echo "./".$lang."/$lite";?>byname/">
<b><?php echo $searchbyname;?>
   <input name="search" type="text" size="40" <?php if (isset($_POST['search'])) echo " value='".$_POST['search']."'";?>>
<input type="submit" value="<?php echo $search;?>">
</form>
<?php 
} 
if (isset($_GET['create'])){
	echo "<embed type='application/x-shockwave-flash' width='1170' height='660' src='./skincraft.swf' quality='best' wmode='Window' pluginspage='http://www.macromedia.com/go/getflashplayer'>";
} elseif (isset($_GET['dskin'])) {
	$db->query("UPDATE `user_skins` SET `dcount`=`dcount`+1,`lastdownload`=UNIX_TIMESTAMP(NOW()) WHERE `skin`='".$db->real_escape_string($_GET['dskin'])."'");
	include 'decresedcount.php';
	DecreseDCount();
?>
	<style type="text/css">
		.left {
			margin: 0px 2px 10px 0px !important;
		}
		.pagination {
			display:none;
		}		
		.main {
			width: 730px !important;
			vertical-align: top;
		}
		.well {
			text-align: center !important;
			margin-bottom: 5px !important;
		}
		.container {
			text-align: left !important;
			min-width: 1205px !important;
		}
		.sidebar {
			margin: 0px 0px 0px 2px !important;			
			display: inline-block !important;
			width: 300px !important;
		}
	</style>
<script type="text/javascript">
function timer(){
 var obj=document.getElementById('countdown');
 obj.innerHTML--;
 if(obj.innerHTML<=0){location.href="<?php echo $dir.$_GET['dskin'].".png";?>";obj.innerHTML=0;setTimeout(function(){},1000);}
 else{setTimeout(timer,1000);}
}
setTimeout(timer,1000);
</script><br>
<?php 
echo "
<div class='well'>
		<div style='text-align:left;'><a href='javascript:history.back()'><div class='btn btn-primary' style='width: 173px;'>$back</div></a></div><br>
		<span style=\"font:bold 110% serif;\">$downloadskinwillstartin<span id=\"countdown\">10</span>.
		<div style='text-align:right;'><a href=\"javascript:document.getElementById('countdown').innerHTML=0\"><div class='btn btn-primary' style='width: 166px;'>$downloadwithoutwait</div></a></div>
</div>";

} elseif (isset($_GET['dcape'])) {
?>
	<style type="text/css">
		.left {

			margin: 0px 2px 10px 2px !important;
		}
		.pagination {
			display:none;
		}		
		.main {
			width: 730px !important;
			vertical-align: top;
		}
		.well {
			text-align: center !important;
			margin-bottom: 5px !important;
		}
		.container {
			text-align: left !important;
			min-width: 1205px !important;
		}
		.sidebar {

			display: inline-block !important;
			width: 300px !important;
		}	
	</style>
<script type="text/javascript">
function timer(){
 var obj=document.getElementById('countdown');
 obj.innerHTML--;
 if(obj.innerHTML<=0){location.href="<?php echo $cloak_dir.$_GET['dcape'].".png";?>";obj.innerHTML=0;setTimeout(function(){},1000);}
 else{setTimeout(timer,1000);}
}
setTimeout(timer,1000);
</script><br>
<?php 
echo "
    <div class='well'>
        <div style='text-align:left;'><a href='javascript:history.back()'><div class='btn btn-primary' style='width: 173px;'>$back</div></a></div><br>
        <span style=\"font:bold 110% serif;\">$downloadcapewillstartin<span id=\"countdown\">10</span>.
        <div style='text-align:right;'><a href=\"javascript:document.getElementById('countdown').innerHTML=0\"><div class='btn btn-primary' style='width: 166px;'>$downloadwithoutwait</div></a></div>
    </div>";	
} elseif (isset($_GET['tags']) && isset($_GET['add'])) {
    if (isset($_GET['add'])){
        if ($_GET['tags']!=NULL){
            $query = "SELECT * FROM `skin_search` WHERE `id`='". (int) $_GET['tags'] . "'";
            $result=$db->query($query);
            $search=$result->fetch_row()[1];
            $array_search=explode(" ",$search);
            $exclude=array('boy','girl','unknown');
            if (in_array('boy', $array_search) || in_array('girl', $array_search) || in_array('unknown', $array_search)){
                $array_search=array_merge ( $exclude, $array_search);
            }
            $where=str_replace (" " , " +", $search);
            $query="SELECT GROUP_CONCAT(DISTINCT `tags` SEPARATOR ' ') FROM (SELECT `tags` FROM `user_skins` WHERE MATCH (tags) AGAINST ('+$where' IN BOOLEAN MODE) GROUP BY `skin`) as `test`";
            $db->query("SET group_concat_max_len =32768");
            $result=$db->query($query);
            $array=$result->fetch_row();
            $search=array_diff (array_unique(explode(" ",$array[0])),$array_search);
            $query="SELECT * FROM `skin_tags` WHERE `tag`='".implode("' OR `tag`='", $search)."'";
            $result=$db->query($query);
            $search=$result->fetch_all();
        } else {
            $query = "SELECT * FROM `skin_tags`";
            $result=$db->query($query);
            $search=$result->fetch_all();
        }
        echo "<div class='well'><div style='text-align:left;'><div  class='panel' style='font-size:25px;'>$tagclouds</div>";
        if (count($search)>0){
            foreach ($search as $tag){
                if ($_GET['tags']==NULL){
                    echo "<a href='$lang/tags/add.".$tag[0]."'><div class='btn btn-primary' style='margin:2px;padding:2px;'>".$tag[1]."</div></a>";
                } else {
                    echo "<a href='$lang/tags.".$_GET['tags']."/add.".$tag[0]."'><div class='btn btn-primary' style='margin:2px;padding:2px;'>".$tag[1]."</div></a>";
                }
            }
        }
        echo "</div></div>";
        if ($_GET['tags']!=NULL)
            echo "<div class='well'><div style='text-align:center;'><br><a href='$lang/tags.".$_GET['tags']."'><div class='btn btn-primary' style='width: 173px;'>$showresults</div></a></div></div>";
        
    }
} else {
    if ($_SERVER['REMOTE_ADDR']=='192.168.0.96' and ($debug==1)){
	    echo "
        	<script>
        	function my_f(DivId,Skin,result_id) {
        		var o=document.getElementById(DivId)
                if(o.style.display == 'none'){
                     jQuery.ajax({
                         url:      'https://skins.minecraft-moscow.ru/tags.php',
                         type:     'POST',
                         dataType: 'text',
                         data: {
                        	 get: Skin
                         },
                         success: function(response) {
                			document.getElementById(result_id).value = response;
                         },
                         error: function(response) {}
                     });
                	o.style.display='block';
                    document.getElementById('skin_id').value = Skin;
                
                }else{o.style.display='none';}
        	}
            function AjaxFormRequest(result_id,form_id) {
                document.getElementById('tagsid').style.display = 'none';
                jQuery.ajax({
                    url:      'https://skins.minecraft-moscow.ru/tags.php',
                    type:     'POST',
                    dataType: 'text',
                    data: jQuery('#'+form_id).serialize(), 
                    success: function(response) {
        	document.getElementById(result_id).value = response;
                    },
                    error: function(response) {}
                });
            }
           </script>
        ";
	    echo "		                
        	<div id='tagsid' style='display:none; position:fixed;top:300px;left:790px;z-index:9999;padding:30px;padding:20px;background-color:rgba(10,10,10,0.8);border-radius:5px;'>
        		<form method='post' action='' id='form_id'>
                    <input id='skin_id' type='hidden' name='skin' value='' />
        		    <input id='result_div_id' type='text' name='tags' value='Антон' style='width:429px;'/><br/><br/><br/><br/><br/>
        		    <input type='button' value='Отправить' onclick=\"AjaxFormRequest('result_div_id', 'form_id')\" />
        		</form>
        	</div>
        ";
    }
	pagination();
	if (!isset($_GET['lite'])){
		if(!empty($clear_files[$_GET['p']])){
			foreach ($clear_files[$_GET['p']] as $index => $path){
				echo "<div class='panel panel-default' style='display: inline-block;margin-right: 5px;margin-top:5px;text-align:center;'>";
				if (isset($_GET['byname'])){
					$res=$db->query("SELECT `mojang` FROM `user_skins` WHERE `skin` = '".substr($path,0,-4)."' AND `name` LIKE '%skins_%'");
					$name=$res->fetch_row();
					echo "<div class='panel-footer'>$name[0]</div>";
				}
				echo "<div class='panel-body'><div id='skinpreview". $index. "' class='skinpreview' style='display:block;'>";
				if ($_SERVER['REMOTE_ADDR']=='192.168.0.96' and $debug==1){
				    $result=$db->query("SELECT `tags` FROM `user_skins` WHERE `skin`='".substr($path,0,-4)."'");
				    $tags=$result->fetch_row()[0];
				    echo "<div style='z-index:9998'>$tags</div>";
				}
				echo "</div></div>";
				if (file_exists($dir. $path)) {
					$ImageSize = getimagesize ( $dir . $path );
					$x=$ImageSize ['0'];
					$y=$ImageSize ['1'];
				} else {
					$x=0;
					$y=0;
				}
				$res=$db->query("SELECT `cloak` FROM `user_skins` WHERE `skin`='".substr($path,0,-4)."' and `cloak`!=''");
				
				//print_r($res->fetch_all());die();
				$cpatch=$res->fetch_all();$cpatch=$cpatch[0][0].".png";
				if($cpatch!=".png"){
					$ImageSize = getimagesize ( $cloak_dir . $cpatch );
					$x1=$ImageSize ['0'];
					$y1=$ImageSize ['1'];
				}				
				echo "<div class='panel-footer'>";
				echo "	<div class='ya-share2' data-services='vkontakte,facebook,twitter,odnoklassniki,moimir,gplus' 
                	data-image='https://skins.minecraft-moscow.ru/s/skin.php?u=".substr($path, 0,-4)."'
                	data-url='https://skins.minecraft-moscow.ru/$lang/dskin.".substr($path, 0,-4)."/'
                    data-size='s'
	                data-title='$ilikethisshin'
                	data-description='$ogdescr'
                	data-direction='vertical'
                	></div>";
		        echo "<div>".$skinsize.": ".$x."x".$y."</div>";
				if(file_exists($cloak_dir.$cpatch) && $cpatch!=$path)
					echo "<div>".$cloaksize.": ".$x1."x".$y1."</div>";
				else 
					echo "<div>".$nocloak."</div>";
				#"./".$lang."/";
				echo "<div class=\"download\"><a rel='nofollow' href='"."./".$lang."/dskin.". substr($path, 0,-4) . "/'><div class='btn btn-primary' style='width:160px'><i class='glyphicon glyphicon-download'></i> ".$downloadskin."</div></a></div>";
				$disabled = " disabled";
				if(file_exists($cloak_dir.$cpatch)&& $cpatch!=$path)
					$disabled = "";
				echo "<div class=\"download\"><a rel='nofollow' href='"."./".$lang."/dcape.". substr($cpatch, 0,-4) . "/'><div class='btn btn-info $disabled' style='width:160px'><i class='glyphicon glyphicon-download-alt'></i> ".$downloadcloak."</div></a></div>";
				if ($_SERVER['REMOTE_ADDR']=='192.168.0.96' and $debug==1)
					echo "<div class=\"download\"><a rel='nofollow' href='/".$lang.$pagination_param."/".$lite."p.".$_GET[p]."/del.". substr($path, 0,-4) . "/'><div class='btn btn-info' style='width:140px'>Удалить</div></a></div>";
				if ($_SERVER['REMOTE_ADDR']=='192.168.0.96' and ($debug==1)){
				    echo "<div class=\"download\" onclick=\"my_f('tagsid','".substr($path, 0,-4)."','result_div_id')\"'><div class='btn btn-info' style='width:140px'>Редактировть тэги</div></div>";
					echo "<div class=\"download\"><a rel='nofollow' href='/".$lang.$pagination_param."/".$lite."p.".$_GET[p]."/?sgirl=". substr($path, 0,-4) . "'><div class='btn btn-info' style='width:140px'>Девочка</div></a></div>";
					echo "<div class=\"download\"><a rel='nofollow' href='/".$lang.$pagination_param."/".$lite."p.".$_GET[p]."/?sboy=". substr($path, 0,-4) . "'><div class='btn btn-info' style='width:140px'>Мальчик</div></a></div>";
					echo "<div class=\"download\"><a rel='nofollow' href='/".$lang.$pagination_param."/".$lite."p.".$_GET[p]."/?sother=". substr($path, 0,-4) . "'><div class='btn btn-info' style='width:140px'>Неизвестно</div></a></div>";
				}
				echo "</div></div>";
				if ((count($clear_files[$_GET['p']])/2)==($index+1)) {
				if ($lang == "ru") 
					echo '';
				else 
					echo "<!-- Yandex.RTB R-A-1586145-1 -->
					<div id='yandex_rtb_R-A-1586145-1'></div>
					<script>window.yaContextCb.push(()=>{
					  Ya.Context.AdvManager.render({
						renderTo: 'yandex_rtb_R-A-1586145-1',
						blockId: 'R-A-1586145-1'
					  })
					})</script>";
				}
			}
		} else {?>
			<div class='panel panel-default' style='display: inline-block;margin-right: 5px;margin-top:5px;text-align:center;'>			
				<?php echo $nofound; ?>
			</div>
			<?php 
		}
	}
	else {
		echo "
<style>
#skin {
    z-index: 25;
	width:200px;
    position:relative;
}
#skin:hover {
transform:scale(2);
    z-index: 50;
    border: 1px solid #e3e3e3;
    border-radius: 2px;
    background-color: white;
				
}#cape {
    z-index: 25;
	width:40px;
    position:relative;
}
#cape:hover {
transform:scale(2);
    z-index: 50;
    border: 1px solid #e3e3e3;
    border-radius: 2px;
    background-color: white;
				
}
</style>			
				";
		if ($clear_files!=null){
			foreach ($clear_files[$_GET['p']] as $index => $path){
	
				echo "<div class='panel panel-default' style='display: inline-block;margin-right: 5px;margin-top:5px;text-align:center;'>";
				if (isset($_GET[byname])){
					$res=$db->query("SELECT `mojang` FROM `user_skins` WHERE `skin` = '".substr($path,0,-4)."' AND `name` LIKE '%skins_%'");
					$name=$res->fetch_row();
					echo "<div class='panel-footer'>$name[0]</div>";
				}
				echo "<div class='panel-body'><div id='skinpreview". $index. "' class='skinpreview' style='display:block; height:200px !important'><img id='skin' src='./s/skin.php?u=".substr($path, 0,-4)."&s=400' style='margin-top:10px;' />";
				$res=$db->query("SELECT `cloak` FROM `user_skins` WHERE `skin`='".substr($path,0,-4)."' and `cloak`!=''");
				//print_r($res->fetch_all());die();
				$cpatch=$res->fetch_all();$cpatch=$cpatch[0][0].".png";
				if($cpatch!=".png"){
					echo "<img id='cape' src='./s/skin.php?u=".substr($cpatch, 0,-4)."&s=80&c'  style='margin-top:10px;'/>";
				}
				
				echo "</div></div>";
				if (file_exists($dir. $path)) {
					$ImageSize = getimagesize ( $dir . $path );
					$x=$ImageSize ['0'];
					$y=$ImageSize ['1'];
				} else {
					$x=0;
					$y=0;
				}
				if(file_exists($cloak_dir.$cpatch)&& $cpatch!=$path)
				{
					$ImageSize = getimagesize ( $cloak_dir . $cpatch );
					$x1=$ImageSize ['0'];
					$y1=$ImageSize ['1'];
				}
				echo "<div class='panel-footer'>";
				echo "	<div class='ya-share2' data-services='vkontakte,facebook,twitter,odnoklassniki,moimir,gplus' 
                	data-image='https://skins.minecraft-moscow.ru/s/skin.php?u=".substr($path, 0,-4)."'
                	data-url='https://skins.minecraft-moscow.ru/$lang/dskin.'".substr($path, 0,-4)."/'
				    data-size='s'
                	data-title='$ilikethisshin'
                	data-description='$ogdescr'
                	data-direction='vertical'
                	></div>";
		        echo "<div>".$skinsize.": ".$x."x".$y."</div>";
				if(file_exists($cloak_dir.$cpatch)&& $cpatch!=$path)
					echo "<div>".$cloaksize.": ".$x1."x".$y1."</div>";
				else
					echo "<div>".$nocloak."</div>";
				echo "<div class=\"download\"><a rel='nofollow' href='"."./".$lang."/dskin.". substr($path, 0,-4) . "/$lite'><div class='btn btn-primary' style='width:160px'><i class='glyphicon glyphicon-download'></i> ".$downloadskin."</div></a></div>";
				$disabled = " disabled";
				if(file_exists($cloak_dir.$cpatch)&& $cpatch!=$path)
					$disabled = "";
				echo "<div class=\"download\"><a rel='nofollow' href='"."./".$lang."/dcape.". substr($cpatch, 0,-4) . "/$lite'><div class='btn btn-info $disabled' style='width:160px'><i class='glyphicon glyphicon-download-alt'></i> ".$downloadcloak."</div></a></div>";
				if ($_SERVER['REMOTE_ADDR']=='192.168.0.96' and $debug==1)
					echo "<div class=\"download\"><a rel='nofollow' href='/".$lang.$pagination_param."/".$lite."p.".$_GET[p]."/del.". substr($path, 0,-4) . "'><div class='btn btn-info' style='width:140px'>Удалить</div></a></div>";
				if ($_SERVER['REMOTE_ADDR']=='192.168.0.96' and ($debug==1)){
				    echo "<div class=\"download\" onclick=\"my_f('tagsid','".substr($path, 0,-4)."','result_div_id')\"'><div class='btn btn-info' style='width:140px'>Редактировть тэги</div></div>";
					echo "<div class=\"download\"><a rel='nofollow' href='/".$lang.$pagination_param."/".$lite."p.".$_GET[p]."/?sgirl=". substr($path, 0,-4) . "'><div class='btn btn-info' style='width:140px'>Девочка</div></a></div>";
					echo "<div class=\"download\"><a rel='nofollow' href='/".$lang.$pagination_param."/".$lite."p.".$_GET[p]."/?sboy=". substr($path, 0,-4) . "'><div class='btn btn-info' style='width:140px'>Мальчик</div></a></div>";
					echo "<div class=\"download\"><a rel='nofollow' href='/".$lang.$pagination_param."/".$lite."p.".$_GET[p]."/?sother=". substr($path, 0,-4) . "'><div class='btn btn-info' style='width:140px'>Неизвестно</div></a></div>";
				}
				echo "</div></div>";
				if ((count($clear_files[$_GET['p']])/2)==($index+1)) {
					echo "
						<!-- Yandex.RTB R-A-9028370-1 -->
						<div id='yandex_rtb_R-A-9028370-1'></div>
						<script>window.yaContextCb.push(()=>{
                        Ya.Context.AdvManager.render({
                            ''blockId': 'R-A-9028370-1',
                            'renderTo': 'yandex_rtb_R-A-9028370-1'
						  })
						})</script>
					";
				}
			}
		} else {?>
			<div class='panel panel-default' style='display: inline-block;margin-right: 5px;margin-top:5px;text-align:center;'>			
				<?php echo $nofound; ?>
			</div>
			<?php 
		}
	}
	pagination();
}

echo "
    <!-- Yandex.RTB R-A-9028370-1 -->
    <div id='yandex_rtb_R-A-9028370-1'></div>
    <script>window.yaContextCb.push(()=>{
    Ya.Context.AdvManager.render({
        ''blockId': 'R-A-9028370-1',
        'renderTo': 'yandex_rtb_R-A-9028370-1'
      })
    })</script>
";
				echo '</div>';
		//if ($lang == "ru")
		echo '';
/*		else
		echo "<!-- Yandex.RTB R-A-1586145-1 -->
<div id='yandex_rtb_R-A-1586145-1'></div>
<script>window.yaContextCb.push(()=>{
  Ya.Context.AdvManager.render({
    renderTo: 'yandex_rtb_R-A-1586145-1',
    blockId: 'R-A-1586145-1'
  })
})</script>";*/
			echo'</div>';
function pagination()
{
	// ��c��������
	global $clear_files, $pagination_param, $lang, $lite;
	echo "<div><ul class='pagination pagination-sm'>";
	if ($_GET['p']>3)
		echo "<li><a href='./$lang"."$pagination_param/$lite'>1</a></li><li class='disabled'><a href='#'>...</a></li>";
	if ($clear_files!=null){
		foreach ($clear_files as $index => $path){
			$n_index=$index+1;
			if ($index<=$_GET['p']+3 and $index>=$_GET['p']-3 and $index!=$_GET['p'])
				if ($index==0)
					echo "<li><a href='./$lang"."$pagination_param/$lite'>" .$n_index . "</a></li>";
				else
					echo "<li><a href='./$lang"."$pagination_param/p.". $index. "/$lite'>" .$n_index . "</a></li>";
			elseif ($index==$_GET['p'])
				echo "<li class='active'><a href='#'>" .$n_index . "</a></li>";
		}
	}
	if ($_GET['p']<count ($clear_files)-4) {
		echo "<li class='disabled'><a href='#'>...</a></li><li><a href='./$lang"."$pagination_param/p.".(count ($clear_files)-1)."/$lite'>".count ($clear_files)."</a></li>";
	}

	echo "</ul></div>";
	// ����� ��c��������
}
function scandir_by_mtime($folder) {
	global $MaxTimeToCache;
	$time_from_cache = json_decode(file_get_contents('s2_skins_dir'.str_replace("/","_",$folder)."time"));
    $flag_from_cache = file_get_contents ('s2_skins_dir'.str_replace("/","_",$folder)."flag");
	$from_cache = json_decode(file_get_contents('s2_skins_dir'.str_replace("/","_",$folder)));
    if((($time_from_cache+($MaxTimeToCache/2))-time() > 0 ) and !isset($_GET['reload']))
    {
    	return $from_cache;
    
	}elseif ($flag_from_cache==0 and !isset($_GET['reload'])) {
		return $from_cache;		
	} else {
		include "addtodb.php";
	    AddToDB();
	    //include "CapeAddToDB.php";
	    //CapeAddToDB();
		file_put_contents ('s2_skins_dir'.str_replace("/","_",$folder)."flag","0");
		//$dircontent = scandir($folder);
        $DB = mysqli_connect('192.168.0.6', 'root', '1234', 'xen');
        $DB->query("SET sql_mode = ''");
        $result=$DB->query("SELECT CONCAT(`skin`,'.png') FROM `user_skins` GROUP BY `skin` ORDER BY `dcount` DESC");
        $to_cache=array();
        while ( $row = $result->fetch_row()) {
			if ( $row[0] != '.png') {            
                $to_cache[]=$row[0];
			}
        }
		file_put_contents('s2_skins_dir'.str_replace("/","_",$folder), json_encode($to_cache));
		file_put_contents('s2_skins_dir'.str_replace("/","_",$folder)."time", json_encode(time()));
		file_put_contents('s2_skins_dir'.str_replace("/","_",$folder)."flag","1");
		//print_r($to_cache);die();
		return $to_cache;
	}
	
	
	
}
function getcapes()
{
	global $db;	
	$res=$db->query("SELECT `skin` FROM `user_skins` WHERE `cloak`!='' and `cloak`!='ecee9c9cfe42ec2ed7d2ea9a28ec6ad3' and `cloak`!=`skin` GROUP BY `cloak`");
	while ($patch=$res->fetch_array())
		$cpatch[]=$patch[0].".png";
	return $cpatch;
}

function gettags()
{
	global $db;	
    $result=$db->query("SELECT * FROM `skin_search` WHERE `id`='".(int) $_GET['tags']."'");
    $tags=str_replace (" " , " +", $result->fetch_row()[1]);
    $query="SELECT `skin` FROM `user_skins` WHERE MATCH (tags) AGAINST ('+$tags' IN BOOLEAN MODE) GROUP BY `skin` ORDER BY `dcount` DESC";
    $result=$db->query($query);
    while ($patch=$result->fetch_row()) 
		$cpatch[]=$patch[0].".png";
    //print_r($cpatch);die();
	return $cpatch;
}
function getboys()
{
	global $db;
	$res=$db->query("SELECT `skin` FROM `user_skins` WHERE `gender`='boy' GROUP BY `skin` ORDER BY `dcount` DESC");
	while ($patch=$res->fetch_array()) 
		$cpatch[]=$patch[0].".png";
	return $cpatch;
}
function getgirls()
{
	global $db;
	$res=$db->query("SELECT `skin` FROM `user_skins` WHERE `gender`='girl' GROUP BY `skin` ORDER BY `dcount` DESC");// or die ($db->error."2");
	while ($patch=$res->fetch_array()) 
		$cpatch[]=$patch[0].".png";
	return $cpatch;
}
function getother()
{
	global $db;
	$res=$db->query("SELECT `skin` FROM `user_skins` WHERE `gender` != 'boy' and `gender` != 'girl' GROUP BY `skin` ORDER BY `dcount` DESC");
	while ($patch=$res->fetch_array()) 
		$cpatch[]=$patch[0].".png";
	return $cpatch;
}
function getunchecked()
{
	global $db;
	$res=$db->query("SELECT `skin` FROM `user_skins` WHERE `gender` IS NULL GROUP BY `skin`");
	while ($patch=$res->fetch_array())
		$cpatch[]=$patch[0].".png";
	return $cpatch;
}
function getbyname($name=false)
{
	global $db;
	if ($name){
		$escapedname=$db->real_escape_string($name);
		$res=$db->query("SELECT `skin`,`checkdate` FROM `user_skins` WHERE `mojang`='$escapedname' and `name` LIKE '%skins_%'");
		if ($res->num_rows>0) {
			$row = $res->fetch_row();
			if ($row[1] < (time()-86400)){
				$filename=download($name);
				if ($filename!=null) {
					$db->query("UPDATE `user_skins` SET `checkdate` =".time().", `skin` = '$filename' WHERE `mojang`='$escapedname' and `name` LIKE '%skins_%'");
					return array("0" => $filename.".png");
				}
				else array("0" => $row[0].".png");
			}
				
			return array("0" => $row[0].".png");
		}
		$filename=download($name);
		if ($filename=='ecee9c9cfe42ec2ed7d2ea9a28ec6ad3') 
			return null;
		if ($filename!=null){
			$res=$db->query("SELECT `name` FROM `user_skins` WHERE `mojang`='$escapedname'");
			if ($res->num_rows==0) {				
				$db->query("INSERT INTO `user_skins` (`name`,`skin`,`mojang`,`checkdate`) 
					VALUES ('skins_$escapedname','$filename','$escapedname','".time()."')");
			}
			return array("0" => $filename.".png");
		}	
		else 
			return null;
	} else {
		$res=$db->query("SELECT `skin` FROM `user_skins` WHERE `name` LIKE '%skins_%' and `skin`!=''");
		while ($patch=$res->fetch_array()) {	
			$cpatch[]=$patch[0].".png";
		}
		return $cpatch;
	}
}

function filter_width($folder, $input, $width)
{
	global $debug, $MaxTimeToCache;
    $flag_filter_width = file_get_contents ('filter_width'.$width."flag");
    $filter_width = json_decode(file_get_contents ('s2_filter_width'.$width));
    $time_filter_width = json_decode(file_get_contents ('s2_filter_width'.$width."time"));
  	if ($_SERVER['REMOTE_ADDR']=='192.168.0.96' and $debug>=2){
    	#$time_filter_width=20;
    	print_r(($time_filter_width+($MaxTimeToCache/2))-time());
    	var_dump($flag_filter_width);
    	if ($debug==3)
    		die();
    }
    
    if(($time_filter_width+($MaxTimeToCache/2))-time() > 0 and !isset($_GET['reload'])) {
		//if ($_SERVER['REMOTE_ADDR']=='192.168.0.96') {
		//	die(($time_filter_width+($MaxTimeToCache/2))-time()." ".$flag_filter_width." 1");
		//}
		return $filter_width;
	}
	elseif ($flag_filter_width==0 and !isset($_GET['reload'])) {
		//if ($_SERVER['REMOTE_ADDR']=='192.168.0.96') {
		//	die(($time_filter_width+($MaxTimeToCache/2))-time()." ".$flag_filter_width." 2");
		//}
		return $filter_width;
	}
	else {
		file_put_contents ('filter_width'.$width."flag" , "0" );		
		$output = array();
		foreach($input as $path)
		{
			if(file_exists($folder.$path)&&filesize($folder.$path))
			{
				$sz = getimagesize($folder.$path);
				if ($width!="HD") {
					if($width == $sz[0])
						$output[] = $path;
				} else
				{
					if (in_array($sz[0], array(128,256,512,1024)))
						$output[] = $path;
				}
			}
		}
		file_put_contents('s2_filter_width'.$width, json_encode($output));
		file_put_contents('s2_filter_width'.$width."time", json_encode(time()));
		file_put_contents ('filter_width'.$width."flag" , "1" );
		//if ($_SERVER['REMOTE_ADDR']=='192.168.0.96') {
		//	die(($time_filter_width+($MaxTimeToCache/2))-time()." ".$flag_filter_width." 3");
		//}
		return $output;
	}
}

function literalise($count, $w1, $w2, $w3)
{
	$count %= 100;
	if($count >=5 && $count<=20) return $w3;
	$count %= 10;
	if($count == 0 || $count >=5)return $w3;
	if($count >=2 && $count <= 4) return $w2;
	return $w1;

}
function parseparams($params){
	global $reqlang, $allowed_langs;
	$reqlang=null;
	foreach ($params as $value){
		if ($value!=null) {
			if (in_array($value, $allowed_langs))
				$reqlang=$value;
			else {
				$par=explode(".",$value);
				if (isset($par[1]))
					$_GET[$par[0]]=$par[1];
				else 
					$_GET[$par[0]]="";
			}
			
		}
	}
}
function GetUUIDByName($name) {
	$data_string='["'.$name.'","nonExistingPlayer"]';
	$ch = curl_init('https://api.mojang.com/profiles/minecraft');
	curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
	curl_setopt($ch, CURLOPT_POSTFIELDS, $data_string);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
	curl_setopt($ch, CURLOPT_HTTPHEADER, array(
	'Content-Type: application/json',
	'Content-Length: ' . strlen($data_string))
	);
	$result =curl_exec($ch); // выполняем запрос curl - обращаемся к сервера php.su
	curl_close($ch);
	$ret=json_decode($result);
	if (!isset($ret[0]->id))
		return false;
	else
		return $ret[0]->id;
}
Function GetURLSkin($uuid) {
	$ch = curl_init('https://sessionserver.mojang.com/session/minecraft/profile/'.$uuid);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
	$result =curl_exec($ch); // выполняем запрос curl - обращаемся к сервера php.su
	curl_close($ch);
	$ret=json_decode($result);
	if (!isset($ret->properties[0]->value))
		return false;
	$prop=json_decode(base64_decode($ret->properties[0]->value));
	if (!isset($prop->textures->SKIN->url))
		return false;
	return $prop->textures->SKIN->url;
}
Function download($User) {
		$timer = json_decode(file_get_contents ("getmojangtimer"));
		if ($timer > (time()-30)) return false;
		file_put_contents ("getmojangtimer", json_encode(time()));
		$uid=GetUUIDByName($User);
		if (!$uid)
			return false;
		else {
			$url = GetURLSkin($uid);
			if ($url == false) {
				return false;
			}
			else {
				$state = get_headers ( $url );		
				if ($state [0] == "HTTP/1.1 200 OK") {
					$sourceFileName = $url;
				} else {
					return false;
				}
			}
		}
		$fp = @fopen ( $sourceFileName, "rb" );
		$fd = @fopen ( "./tmp/" . strtolower ( $User ) . ".png", "w" );
		
		if ($fp && $fd) {
			
			while ( ! feof ( $fp ) ) {
				$st = fread ( $fp, 4096 );
				fwrite ( $fd, $st );
			
			}
			$md5=md5_file("./tmp/" . strtolower ( $User ) . ".png");
			rename("./tmp/" . strtolower ( $User ) . ".png", "./skins/$md5.png");
		}
		@fclose ( $fp );
		@fclose ( $fd );
	if	(isset($md5)) return $md5;
	 else return null;	
}?>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62566823-2', 'auto');
  ga('send', 'pageview');

</script>		
		
	<!-- Yandex.Metrika counter -->
<script type="text/javascript">
(function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter24489719 = new Ya.Metrika({id:24489719,
                    webvisor:false,
                    clickmap:false,
                    trackLinks:false,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
})(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="//mc.yandex.ru/watch/24489719" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
<div class="well" style="margin-top:10px;"><?php echo $searchenginestext;?></div>
    <div class="well" style="margin-top:10px;">© Minecraft Moscow 2024. All images are copyrighted by their owners.
    </div>
</div>
</div>
<div class="aside" style="display:none;border:1px solid black;float:right;width:100px;position:fixed;right:0px;top:0px;height:100%;"></div>
<?php 
if ($_SERVER['REMOTE_ADDR']=='192.168.0.96' and $debug==2){
 print_r(($MaxTimeToCache-time()+$memcache_obj->get('s2_filter_width'.$_GET[width]."time"))/2);
 #var_dump($memcache_obj->getOption(Memcached::OPT_POLL_TIMEOUT));
 }
?>
</body>
</html>
